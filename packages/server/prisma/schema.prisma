generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANT & AUTH
// ============================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  settings  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users     User[]
  filieres  Filiere[]
  clients   Client[]
  products  Product[]
  productKits ProductKit[]

  @@map("tenants")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  role         Role     @default(COMMERCIAL)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  tenantId     String   @map("tenant_id")
  tenant       Tenant   @relation(fields: [tenantId], references: [id])

  clientId     String?  @map("client_id")
  client       Client?  @relation("DistributeurClient", fields: [clientId], references: [id])

  filieres     UserFiliere[] @relation("UserFilieres")

  clients      Client[] @relation("CommercialClients")
  notes        Note[]
  visits       Visit[]
  auditLogs    AuditLog[]
  opportunities Opportunity[] @relation("OpportunityOwner")
  orders       Order[] @relation("OrderOwner")
  opportunityNotes OpportunityNote[] @relation("OpportunityNoteAuthor")
  opportunityEvents OpportunityEvent[] @relation("OpportunityEventUser")

  @@map("users")
}

enum Role {
  ADMIN
  RESPONSABLE_FILIERE
  COMMERCIAL
  QUALITE
  DISTRIBUTEUR
}

enum ClientSegmentation {
  DISTRIBUTEUR
  AGENT
  AUTRES
}

// ============================================
// ORGANISATION
// ============================================

model Filiere {
  id        String   @id @default(uuid())
  name      String
  code      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  responsables UserFiliere[] @relation("FilierResponsables")
  clients      ClientFiliere[]
  products     Product[]

  @@unique([tenantId, code])
  @@map("filieres")
}

model UserFiliere {
  userId    String   @map("user_id")
  user      User     @relation("UserFilieres", fields: [userId], references: [id], onDelete: Cascade)
  filiereId String   @map("filiere_id")
  filiere   Filiere  @relation("FilierResponsables", fields: [filiereId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@id([userId, filiereId])
  @@map("user_filieres")
}

model ClientFiliere {
  clientId  String   @map("client_id")
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  filiereId String   @map("filiere_id")
  filiere   Filiere  @relation(fields: [filiereId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@id([clientId, filiereId])
  @@map("client_filieres")
}

// ============================================
// CLIENTS (DISTRIBUTEURS)
// ============================================

model Client {
  id            String   @id @default(uuid())
  name          String
  organization  String?
  addressLine1  String?  @map("address_line1")
  addressLine2  String?  @map("address_line2")
  city          String?
  region        String?
  postalCode    String?  @map("postal_code")
  country       String   @default("FR")
  phone         String?
  email         String?
  latitude      Float?
  longitude     Float?
  isActive      Boolean  @default(true) @map("is_active")
  portailEnabled Boolean @default(false) @map("portail_enabled")
  segmentation  ClientSegmentation @default(AUTRES)
  deletedAt     DateTime? @map("deleted_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  tenantId    String   @map("tenant_id")
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  filieres    ClientFiliere[]

  commercialId String? @map("commercial_id")
  commercial   User?   @relation("CommercialClients", fields: [commercialId], references: [id])

  notes         Note[]
  visits        Visit[]
  lots          LotClient[]
  orders        Order[]
  opportunities Opportunity[]
  distributeurs User[] @relation("DistributeurClient")

  @@map("clients")
}

// ============================================
// VISITES & NOTES
// ============================================

model Visit {
  id        String   @id @default(uuid())
  date      DateTime
  subject   String?
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  clientId  String?  @map("client_id")
  client    Client?  @relation(fields: [clientId], references: [id])

  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])

  photos    Photo[]

  @@map("visits")
}

model Note {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  clientId  String   @map("client_id")
  client    Client   @relation(fields: [clientId], references: [id])

  authorId  String   @map("author_id")
  author    User     @relation(fields: [authorId], references: [id])

  @@map("notes")
}

model Photo {
  id        String   @id @default(uuid())
  url       String
  caption   String?
  createdAt DateTime @default(now()) @map("created_at")

  visitId   String   @map("visit_id")
  visit     Visit    @relation(fields: [visitId], references: [id])

  @@map("photos")
}

// ============================================
// TRAÇABILITÉ GS1.128
// ============================================

model Product {
  id          String    @id @default(uuid())
  code        String
  gtin        String?   @unique
  name        String
  description String?
  unitPrice   Float     @default(0) @map("unit_price")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  filiereId   String?   @map("filiere_id")
  filiere     Filiere?  @relation(fields: [filiereId], references: [id])

  tenantId    String    @map("tenant_id")
  tenant      Tenant    @relation(fields: [tenantId], references: [id])

  lots        Lot[]
  kitItems    ProductKitItem[]
  opportunityLines OpportunityLine[]
  orderLines  OrderLine[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([filiereId])
  @@index([isActive])
  @@map("products")
}

model Lot {
  id            String   @id @default(uuid())
  lotNumber     String   @map("lot_number")
  expirationDate DateTime? @map("expiration_date")
  rawBarcode    String?  @map("raw_barcode")
  createdAt     DateTime @default(now()) @map("created_at")

  productId     String   @map("product_id")
  product       Product  @relation(fields: [productId], references: [id])

  clients       LotClient[]

  @@unique([productId, lotNumber])
  @@map("lots")
}

model LotClient {
  id           String   @id @default(uuid())
  quantity     Int      @default(1)
  deliveryDate DateTime @map("delivery_date")
  createdAt    DateTime @default(now()) @map("created_at")

  lotId        String   @map("lot_id")
  lot          Lot      @relation(fields: [lotId], references: [id])

  clientId     String   @map("client_id")
  client       Client   @relation(fields: [clientId], references: [id])

  @@map("lot_clients")
}

// ============================================
// COMMANDES
// ============================================

model Order {
  id                String      @id @default(uuid())
  reference         String      @unique
  status            OrderStatus @default(BROUILLON)
  totalHT           Float       @default(0) @map("total_ht")
  totalTTC          Float       @default(0) @map("total_ttc")
  taxRate           Float       @default(20) @map("tax_rate")
  manualAmount      Float       @default(0) @map("manual_amount")
  expectedDelivery  DateTime?   @map("expected_delivery")
  deliveredAt       DateTime?   @map("delivered_at")
  trackingNumber    String?     @map("tracking_number")
  notes             String?
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  validatedAt       DateTime?   @map("validated_at")

  clientId          String      @map("client_id")
  client            Client      @relation(fields: [clientId], references: [id])

  ownerId           String      @map("owner_id")
  owner             User        @relation("OrderOwner", fields: [ownerId], references: [id])

  opportunityId     String?     @map("opportunity_id")
  opportunity       Opportunity? @relation(fields: [opportunityId], references: [id])

  tenantId          String      @map("tenant_id")

  lines             OrderLine[]

  @@index([status])
  @@index([ownerId])
  @@index([clientId])
  @@index([opportunityId])
  @@map("orders")
}

model OrderLine {
  id            String   @id @default(uuid())
  productName   String   @map("product_name")
  productCode   String?  @map("product_code")
  quantity      Int      @default(1)
  unitPrice     Float    @map("unit_price")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  orderId       String   @map("order_id")
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId     String?  @map("product_id")
  product       Product? @relation(fields: [productId], references: [id])

  kitId         String?  @map("kit_id")
  kit           ProductKit? @relation(fields: [kitId], references: [id])

  @@map("order_lines")
}

enum OrderStatus {
  BROUILLON
  VALIDEE
  PREPARATION
  EXPEDIEE
  LIVREE
  ANNULEE
}

// ============================================
// CATALOGUE PRODUITS (KITS)
// ============================================

model ProductKit {
  id          String    @id @default(uuid())
  code        String
  name        String
  description String?
  price       Float
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  tenantId    String    @map("tenant_id")
  tenant      Tenant    @relation(fields: [tenantId], references: [id])

  items       ProductKitItem[]
  opportunityLines OpportunityLine[]
  orderLines  OrderLine[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([isActive])
  @@map("product_kits")
}

model ProductKitItem {
  id        String      @id @default(uuid())
  quantity  Int         @default(1)

  kitId     String      @map("kit_id")
  kit       ProductKit  @relation(fields: [kitId], references: [id], onDelete: Cascade)

  productId String      @map("product_id")
  product   Product     @relation(fields: [productId], references: [id])

  @@unique([kitId, productId])
  @@map("product_kit_items")
}

// ============================================
// PIPELINE & OPPORTUNITÉS
// ============================================

model Opportunity {
  id              String            @id @default(uuid())
  title           String
  contactName     String            @map("contact_name")
  contactEmail    String?           @map("contact_email")
  contactPhone    String?           @map("contact_phone")
  source          OpportunitySource
  amount          Float
  manualAmount    Float             @default(0) @map("manual_amount")
  probability     Int               @default(10)
  probabilityHistory Json?          @map("probability_history")
  expectedCloseDate DateTime        @map("expected_close_date")
  status          OpportunityStatus @default(NOUVEAU)
  lostReason      String?           @map("lost_reason")
  lostComment     String?           @map("lost_comment")
  notes           String?
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  clientId        String            @map("client_id")
  client          Client            @relation(fields: [clientId], references: [id])

  ownerId         String            @map("owner_id")
  owner           User              @relation("OpportunityOwner", fields: [ownerId], references: [id])

  previousOwnerId String?           @map("previous_owner_id")
  ownerChangedAt  DateTime?         @map("owner_changed_at")

  tenantId        String            @map("tenant_id")

  lines           OpportunityLine[]
  orders          Order[]
  historyNotes    OpportunityNote[]
  events          OpportunityEvent[]

  @@index([status])
  @@index([ownerId])
  @@index([clientId])
  @@map("opportunities")
}

model OpportunityLine {
  id            String      @id @default(uuid())
  productName   String      @map("product_name")
  quantity      Int         @default(1)
  unitPrice     Float       @map("unit_price")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  opportunityId String      @map("opportunity_id")
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  productId     String?     @map("product_id")
  product       Product?    @relation(fields: [productId], references: [id])

  kitId         String?     @map("kit_id")
  kit           ProductKit? @relation(fields: [kitId], references: [id])

  @@map("opportunity_lines")
}

enum OpportunityStatus {
  NOUVEAU
  QUALIFICATION
  PROPOSITION
  NEGOCIATION
  GAGNE
  CONVERTI
  PERDU
}

enum OpportunitySource {
  SALON
  APPEL_ENTRANT
  RECOMMANDATION
  SITE_WEB
  AUTRE
}

// ============================================
// OPPORTUNITÉS - HISTORIQUE & TIMELINE (Story 9.6)
// ============================================

model OpportunityNote {
  id            String      @id @default(uuid())
  content       String
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  opportunityId String      @map("opportunity_id")
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  authorId      String      @map("author_id")
  author        User        @relation("OpportunityNoteAuthor", fields: [authorId], references: [id])

  @@index([opportunityId])
  @@index([createdAt])
  @@map("opportunity_notes")
}

model OpportunityEvent {
  id            String              @id @default(uuid())
  type          OpportunityEventType
  description   String?
  metadata      Json?
  createdAt     DateTime            @default(now()) @map("created_at")

  opportunityId String              @map("opportunity_id")
  opportunity   Opportunity         @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  userId        String?             @map("user_id")
  user          User?               @relation("OpportunityEventUser", fields: [userId], references: [id])

  @@index([opportunityId])
  @@index([createdAt])
  @@index([type])
  @@map("opportunity_events")
}

enum OpportunityEventType {
  STATUS_CHANGE
  NOTE_ADDED
  OWNER_CHANGE
  AMOUNT_CHANGE
  LINE_ADDED
  LINE_REMOVED
  LINE_UPDATED
  DOCUMENT_ATTACHED
  RDV_SCHEDULED
  EMAIL_SENT
  CREATED
}

// ============================================
// AUDIT LOG (IMMUTABLE)
// ============================================

model AuditLog {
  id         String   @id @default(uuid())
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  userId     String?  @map("user_id")
  user       User?    @relation(fields: [userId], references: [id])

  tenantId   String   @map("tenant_id")

  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
