# =============================================================================
# GitHub Actions - Deploy to Railway
# Déclenché sur push vers main ou manuellement
# =============================================================================

name: Deploy to Railway

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  # ---------------------------------------------------------------------------
  # Tests
  # ---------------------------------------------------------------------------
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm run test --if-present

  # ---------------------------------------------------------------------------
  # Deploy Backend
  # ---------------------------------------------------------------------------
  deploy-backend:
    name: Deploy Backend to Railway
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy Backend
        run: |
          cd packages/server
          railway up --service cdiagvet-server
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Run Prisma Migrations
        run: |
          railway run --service cdiagvet-server -- npx prisma migrate deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # ---------------------------------------------------------------------------
  # Deploy Frontend
  # ---------------------------------------------------------------------------
  deploy-frontend:
    name: Deploy Frontend to Railway
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy Frontend
        run: |
          cd packages/front
          railway up --service cdiagvet-front
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # ---------------------------------------------------------------------------
  # Health Check
  # ---------------------------------------------------------------------------
  health-check:
    name: Verify Deployment
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Check Backend Health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://api.cdiagvet.fr/health)
          if [ "$response" != "200" ]; then
            echo "Backend health check failed with status $response"
            exit 1
          fi
          echo "Backend is healthy!"

      - name: Check Frontend
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://app.cdiagvet.fr)
          if [ "$response" != "200" ]; then
            echo "Frontend check failed with status $response"
            exit 1
          fi
          echo "Frontend is accessible!"
